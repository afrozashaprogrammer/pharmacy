{% extends 'administration/base.html' %}
{% block content %}
<main class="p-6 space-y-6">

  <!-- PAGE HEADER -->
  <div class="flex items-center justify-between">
    <h1 class="text-2xl font-semibold text-slate-800 dark:text-slate-100">
      All Tests & Price
    </h1>
    <button id="openTestOffcanvas"
      class="px-4 py-2 text-white bg-primary rounded-lg shadow hover:bg-primary/90">
      + Add New Test
    </button>
  </div>

  <!-- TEST TABLE CONTAINER -->
  <div id="testTableParentContainer">
    {% include 'administration/htmx/test_table.html' %}
  </div>

  <!-- BACKDROP -->
  <div id="testBackdrop" class="fixed inset-0 bg-black bg-opacity-40 hidden z-40"></div>

</main>

<!-- ADD / EDIT TEST OFFCANVAS -->
<div id="testOffcanvas"
    class="fixed top-0 right-0 h-full w-80 bg-white dark:bg-slate-800 shadow-xl transform translate-x-full transition-all duration-300 z-[9999]">

  <!-- Header -->
  <div class="p-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
    <h2 id="offcanvasTitle" class="text-xl font-semibold">Add New Test</h2>
    <button id="closeTestOffcanvas" class="text-slate-500 hover:text-slate-800 dark:hover:text-slate-300">✕</button>
  </div>

  <!-- Scrollable Body -->
  <div class="p-4 overflow-y-auto" style="max-height: calc(100vh - 64px);">
    <form id="testForm" method="POST" action="{% url 'administration:create_test' %}">
      {% csrf_token %}
      <input type="hidden" id="test_id" name="test_id">

      <div class="space-y-4">

        <!-- Test Name -->
        <div>
          <label class="text-sm">Test Name</label>
          <input type="text" name="name" required placeholder="Enter test name"
            class="mt-1 px-3 py-2 w-full rounded-lg border border-slate-300 dark:border-slate-700 
                   bg-slate-50 dark:bg-slate-900 focus:ring-2 focus:ring-primary/60">
        </div>

        <!-- Test Code -->
        <div>
          <label class="text-sm">Test Code</label>
          <input type="text" name="code" placeholder="Enter test code"
            class="mt-1 px-3 py-2 w-full rounded-lg border border-slate-300 dark:border-slate-700 
                   bg-slate-50 dark:bg-slate-900 focus:ring-2 focus:ring-primary/60">
        </div>

        <!-- Price -->
        <div>
          <label class="text-sm">Price (৳)</label>
          <input type="number" name="price" step="0.01" placeholder="Enter price"
            class="mt-1 px-3 py-2 w-full rounded-lg border border-slate-300 dark:border-slate-700 
                   bg-slate-50 dark:bg-slate-900 focus:ring-2 focus:ring-primary/60">
        </div>

        <!-- Discount Type -->
        <div>
          <label class="text-sm">Discount Type</label>
          <select name="discount_type"
            class="mt-1 px-3 py-2 w-full rounded-lg border border-slate-300 dark:border-slate-700 
                   bg-slate-50 dark:bg-slate-900">
            <option value="">--Select--</option>
            <option value="percent">Percentage</option>
            <option value="flat">Flat</option>
          </select>
        </div>

        <!-- Discount Value -->
        <div>
          <label class="text-sm">Discount Value</label>
          <input type="number" name="discount_value" step="0.01"
            class="mt-1 px-3 py-2 w-full rounded-lg border border-slate-300 dark:border-slate-700 
                   bg-slate-50 dark:bg-slate-900">
        </div>

        <!-- Sample Type -->
        <div>
          <label class="text-sm">Sample Type</label>
          <select name="sample_type"
            class="mt-1 px-3 py-2 w-full rounded-lg border border-slate-300 dark:border-slate-700 
                   bg-slate-50 dark:bg-slate-900">
            <option value="">--Select--</option>
            <option value="blood">Blood</option>
            <option value="urine">Urine</option>
            <option value="stool">Stool</option>
            <option value="saliva">Saliva</option>
            <option value="xray">Xray</option>
            <option value="ct">CT Scan</option>
            <option value="mri">MRI</option>
            <option value="ultrasound">Ultrasound</option>
          </select>
        </div>

        <!-- Fasting Required -->
        <div class="flex items-center mt-2">
          <label class="text-sm mr-2">
            <input type="checkbox" name="fasting_required"> Fasting Required
          </label>
        </div>

        <!-- Processing Time -->
        <div>
          <label class="text-sm">Processing Time (hours)</label>
          <input type="number" name="processing_time_hours"
            class="mt-1 px-3 py-2 w-full rounded-lg border border-slate-300 dark:border-slate-700 
                   bg-slate-50 dark:bg-slate-900" placeholder="e.g. 24">
        </div>

        <!-- Unit -->
        <div>
          <label class="text-sm">Unit</label>
          <input type="text" name="unit"
            class="mt-1 px-3 py-2 w-full rounded-lg border border-slate-300 dark:border-slate-700 
                   bg-slate-50 dark:bg-slate-900">
        </div>

        <!-- Has Range -->
        <div>
          <label class="text-sm">Has Range</label>
          <input type="text" name="has_range"
            class="mt-1 px-3 py-2 w-full rounded-lg border border-slate-300 dark:border-slate-700 
                   bg-slate-50 dark:bg-slate-900">
        </div>

        <!-- Report Format -->
        <div>
          <label class="text-sm">Report Format</label>
          <select name="report_format"
            class="mt-1 px-3 py-2 w-full rounded-lg border border-slate-300 dark:border-slate-700 
                   bg-slate-50 dark:bg-slate-900">
            <option value="pdf">PDF</option>
            <option value="text">Text</option>
          </select>
        </div>

        <!-- Reference Range -->
        <div>
          <label class="text-sm">Reference Range</label>
          <input type="text" name="reference_range"
            class="mt-1 px-3 py-2 w-full rounded-lg border border-slate-300 dark:border-slate-700 
                   bg-slate-50 dark:bg-slate-900">
        </div>

        <!-- Gender Specific -->
        <div>
          <label class="text-sm">Gender Specific</label>
          <select name="gender_specific"
            class="mt-1 px-3 py-2 w-full rounded-lg border border-slate-300 dark:border-slate-700 
                   bg-slate-50 dark:bg-slate-900">
            <option value="Both">Both</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
          </select>
        </div>

        <!-- Description -->
        <div>
          <label class="text-sm">Description</label>
          <textarea name="description"
            class="mt-1 px-3 py-2 w-full rounded-lg border border-slate-300 dark:border-slate-700
                   bg-slate-50 dark:bg-slate-900"></textarea>
        </div>

        <!-- Instructions -->
        <div>
          <label class="text-sm">Instructions</label>
          <textarea name="instructions"
            class="mt-1 px-3 py-2 w-full rounded-lg border border-slate-300 dark:border-slate-700
                   bg-slate-50 dark:bg-slate-900"></textarea>
        </div>

        <!-- Save Button -->
        <button
          class="w-full py-2 bg-primary text-white rounded-lg hover:bg-primary/90">
          Save
        </button>

      </div>
    </form>
  </div>
</div>

<!-- HTMX + Offcanvas Script -->
<script>
const offcanvas = document.getElementById("testOffcanvas");
const backdrop = document.getElementById("testBackdrop");
const openBtn = document.getElementById("openTestOffcanvas");
const closeBtn = document.getElementById("closeTestOffcanvas");
const form = document.getElementById("testForm");
const title = document.getElementById("offcanvasTitle");

// Open Add
openBtn.addEventListener("click", () => {
  form.reset();
  title.textContent = "Add New Test";
  form.action = "{% url 'administration:create_test' %}";
  offcanvas.classList.remove("translate-x-full");
  backdrop.classList.remove("hidden");
});

// Close Offcanvas
function closeCanvas() {
  offcanvas.classList.add("translate-x-full");
  backdrop.classList.add("hidden");
}
closeBtn.addEventListener("click", closeCanvas);
backdrop.addEventListener("click", closeCanvas);

// Edit Button Handler
document.body.addEventListener("click", function(e) {
  const btn = e.target.closest(".edit-test-btn");
  if (!btn) return;

  title.textContent = "Edit Test";

  form.name.value = btn.dataset.name;
  form.code.value = btn.dataset.code;
  form.price.value = btn.dataset.price;
  form.discount_type.value = btn.dataset.discount_type;
  form.discount_value.value = btn.dataset.discount_value;
  form.sample_type.value = btn.dataset.sample;
  form.fasting_required.checked = btn.dataset.fasting === "True";
  form.processing_time_hours.value = btn.dataset.processing;
  form.unit.value = btn.dataset.unit;
  form.has_range.value = btn.dataset.has_range;
  form.report_format.value = btn.dataset.report;
  form.reference_range.value = btn.dataset.reference;
  form.gender_specific.value = btn.dataset.gender;
  form.description.value = btn.dataset.description;
  form.instructions.value = btn.dataset.instructions;

  form.action = "{% url 'administration:update_test' 0 %}".replace("0", btn.dataset.id);

  offcanvas.classList.remove("translate-x-full");
  backdrop.classList.remove("hidden");
});
</script>

{% endblock %}
